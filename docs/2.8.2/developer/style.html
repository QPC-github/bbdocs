

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.3.2. Buildbot Coding Style &mdash; Buildbot 2.8.2 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/icon.png"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.3.3. Buildbot’s Test Suite" href="tests.html" />
    <link rel="prev" title="3.3.1. Master Organization" href="master-overview.html" /> 
<!-- GA-TRACKING-START -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker("UA-12313843-4");
pageTracker._setDomainName("none");
pageTracker._setAllowLinker(true);
pageTracker._trackPageview();
} catch(err) {}
</script>
<!-- GA-TRACKING-END -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Buildbot
          

          
            
            <img src="../_static/full_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.8.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">1. Buildbot Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manual/index.html">2. Buildbot Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Buildbot Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">3.1. Development Quick-start</a></li>
<li class="toctree-l2"><a class="reference internal" href="pull-request.html">3.2. Submitting Pull Requests</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="general.html">3.3. General Documents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="master-overview.html">3.3.1. Master Organization</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.3.2. Buildbot Coding Style</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#documentation">3.3.2.1. Documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#symbol-names">3.3.2.2. Symbol Names</a></li>
<li class="toctree-l4"><a class="reference internal" href="#twisted-idioms">3.3.2.3. Twisted Idioms</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="tests.html">3.3.3. Buildbot’s Test Suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="config.html">3.3.4. Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="config.html#configuration-in-angularjs">3.3.5. Configuration in AngularJS</a></li>
<li class="toctree-l3"><a class="reference internal" href="schedulers.html">3.3.6. Writing Schedulers</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils.html">3.3.7. Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="results.html">3.3.8. Build Result Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="www-server.html">3.3.9. WWW Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="www-data-module.html">3.3.10. Javascript Data Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="www-base-app.html">3.3.11. Base web application</a></li>
<li class="toctree-l3"><a class="reference internal" href="auth.html">3.3.12. Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="authz.html">3.3.13. Authorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="master-worker.html">3.3.14. Master-Worker API</a></li>
<li class="toctree-l3"><a class="reference internal" href="br-claiming.html">3.3.15. Claiming Build Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="encodings.html">3.3.16. String Encodings</a></li>
<li class="toctree-l3"><a class="reference internal" href="metrics.html">3.3.17. Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="secrets.html">3.3.18. Secrets</a></li>
<li class="toctree-l3"><a class="reference internal" href="secrets.html#secrets-manager">3.3.19. Secrets manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="secrets.html#secrets-providers">3.3.20. Secrets providers</a></li>
<li class="toctree-l3"><a class="reference internal" href="stats-service.html">3.3.21. Statistics Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins-publish.html">3.3.22. How to package Buildbot plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rest.html">3.4. REST API</a></li>
<li class="toctree-l2"><a class="reference internal" href="raml/index.html">3.5. REST API Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="data.html">3.6. Data API</a></li>
<li class="toctree-l2"><a class="reference internal" href="database.html">3.7. Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="mq.html">3.8. Messaging and Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="classes.html">3.9. Classes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../relnotes/index.html">4. Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../relnotes/index.html#older-release-notes">5. Older Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../indices.html">6. Indices and Tables</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Buildbot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">3. Buildbot Development</a> &raquo;</li>
        
          <li><a href="general.html">3.3. General Documents</a> &raquo;</li>
        
      <li>3.3.2. Buildbot Coding Style</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developer/style.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Buildbot no longer supports Python 2.7 on the Buildbot master.</p>
</div>
<div class="section" id="buildbot-coding-style">
<h1>3.3.2. Buildbot Coding Style<a class="headerlink" href="#buildbot-coding-style" title="Permalink to this headline">¶</a></h1>
<div class="section" id="documentation">
<h2>3.3.2.1. Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<p>Buildbot strongly encourages developers to document the methods, behavior, and usage of classes that users might interact with.
However, this documentation should be in <code class="docutils literal notranslate"><span class="pre">.rst</span></code> files under <code class="docutils literal notranslate"><span class="pre">master/docs/developer</span></code>, rather than in docstrings within the code.
For private methods or where code deserves some kind of explanatory preface, use comments instead of a docstring.
While some docstrings remain within the code, these should be migrated to documentation files and removed as the code is modified.</p>
<p>Within the reStructuredText files, write with each English sentence on its own line.
While this does not affect the generated output, it makes git diffs between versions of the documentation easier to read, as they are not obscured by changes due to re-wrapping.
This convention is not followed everywhere, but we are slowly migrating documentation from the old (wrapped) style as we update it.</p>
</div>
<div class="section" id="symbol-names">
<h2>3.3.2.2. Symbol Names<a class="headerlink" href="#symbol-names" title="Permalink to this headline">¶</a></h2>
<p>Buildbot follows <a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP8</a> regarding the formatting of symbol names.
Because Buildbot uses Twisted so heavily, and Twisted uses interCaps, this is not very consistently applied throughout the codebase.</p>
<p>The single exception to PEP8 is in naming of functions and methods.
That is, you should spell methods and functions with the first character in lower-case, and the first letter of subsequent words capitalized, e.g., <code class="docutils literal notranslate"><span class="pre">compareToOther</span></code> or <code class="docutils literal notranslate"><span class="pre">getChangesGreaterThan</span></code>.</p>
<p>Symbols used as parameters to functions used in configuration files should use underscores.</p>
<p>In summary, then:</p>
<table border="1" class="docutils">
<colgroup>
<col width="65%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Symbol Type</th>
<th class="head">Format</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Methods</td>
<td>interCaps</td>
</tr>
<tr class="row-odd"><td>Functions</td>
<td>interCaps</td>
</tr>
<tr class="row-even"><td>Function Arguments</td>
<td>under_scores</td>
</tr>
<tr class="row-odd"><td>API method Arguments</td>
<td>interCaps</td>
</tr>
<tr class="row-even"><td>Classes</td>
<td>InitialCaps</td>
</tr>
<tr class="row-odd"><td>Variables</td>
<td>under_scores</td>
</tr>
<tr class="row-even"><td>Constants</td>
<td>ALL_CAPS</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="twisted-idioms">
<h2>3.3.2.3. Twisted Idioms<a class="headerlink" href="#twisted-idioms" title="Permalink to this headline">¶</a></h2>
<p>Programming with Twisted Python can be daunting.  But sticking to a few
well-defined patterns can help avoid surprises.</p>
<div class="section" id="prefer-to-return-deferreds">
<h3>Prefer to Return Deferreds<a class="headerlink" href="#prefer-to-return-deferreds" title="Permalink to this headline">¶</a></h3>
<p>If you’re writing a method that doesn’t currently block, but could conceivably
block sometime in the future, return a Deferred and document that it does so.
Just about anything might block - even getters and setters!</p>
</div>
<div class="section" id="helpful-twisted-classes">
<h3>Helpful Twisted Classes<a class="headerlink" href="#helpful-twisted-classes" title="Permalink to this headline">¶</a></h3>
<p>Twisted has some useful, but little-known classes.
Brief descriptions follow, but you should consult the API documentation or source code
for the full details.</p>
<dl class="docutils">
<dt><code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.task.LoopingCall</span></code></dt><dd>Calls an asynchronous function repeatedly at set intervals.
Note that this will stop looping if the function fails.
In general, you will want to wrap the function to capture and log errors.</dd>
<dt><code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.application.internet.TimerService</span></code></dt><dd>Similar to <code class="docutils literal notranslate"><span class="pre">t.i.t.LoopingCall</span></code>, but implemented as a service that will automatically start and stop the function calls when the service starts and stops.
See the warning about failing functions for <code class="docutils literal notranslate"><span class="pre">t.i.t.LoopingCall</span></code>.</dd>
</dl>
</div>
<div class="section" id="sequences-of-operations">
<h3>Sequences of Operations<a class="headerlink" href="#sequences-of-operations" title="Permalink to this headline">¶</a></h3>
<p>Especially in Buildbot, we’re often faced with executing a sequence of
operations, many of which may block.</p>
<p>In all cases where this occurs, there is a danger of pre-emption, so exercise
the same caution you would if writing a threaded application.</p>
<p>For simple cases, you can use nested callback functions. For more complex cases, inlineCallbacks is appropriate.
In all cases, please prefer maintainability and readability over performance.</p>
<div class="section" id="nested-callbacks">
<h4>Nested Callbacks<a class="headerlink" href="#nested-callbacks" title="Permalink to this headline">¶</a></h4>
<p>First, an admonition: do not create extra class methods that represent the continuations of the first:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myMethod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_myMethod_2</span><span class="p">)</span> <span class="c1"># BAD!</span>
<span class="k">def</span> <span class="nf">_myMethod_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>         <span class="c1"># BAD!</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Invariably, this extra method gets separated from its parent as the code
evolves, and the result is completely unreadable. Instead, include all of the
code for a particular function or method within the same indented block, using
nested functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getRevInfo</span><span class="p">(</span><span class="n">revname</span><span class="p">):</span>
    <span class="c1"># for example only! See above a better implementation with inlineCallbacks</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rev_parse</span><span class="p">(</span><span class="n">_</span><span class="p">):</span> <span class="c1"># note use of &#39;_&#39; to quietly indicate an ignored parameter</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="n">git</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="n">revname</span> <span class="p">])</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">rev_parse</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">parse_rev_parse</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="n">git</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=</span><span class="si">%s</span><span class="s1">%n%b&#39;</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="p">])</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">parse_rev_parse</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">parse_log</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">parse_log</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_results</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">set_results</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>it is usually best to make the first operation occur within a callback, as the
deferred machinery will then handle any exceptions as a failure in the outer
Deferred.  As a shortcut, <code class="docutils literal notranslate"><span class="pre">d.addCallback</span></code> works as a decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="nd">@d</span><span class="o">.</span><span class="n">addCallback</span>
<span class="k">def</span> <span class="nf">rev_parse</span><span class="p">(</span><span class="n">_</span><span class="p">):</span> <span class="c1"># note use of &#39;_&#39; to quietly indicate an ignored parameter</span>
    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="n">git</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="n">revname</span> <span class="p">])</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">d.addCallback</span></code> is not really a decorator as it does not return a modified function.
As a result in previous code, <code class="docutils literal notranslate"><span class="pre">rev_parse</span></code> value is actually the Deferred.
In general the <code class="xref py py-class docutils literal notranslate"><span class="pre">inlineCallbacks</span></code> method is preferred inside new code as it keeps the code easier to read.
As a general rule of thumb, when you need more than 2 callbacks in the same method, it’s time to switch it to  <code class="xref py py-class docutils literal notranslate"><span class="pre">inlineCallbacks</span></code>.
This would be for example the case for previous <code class="xref py py-func docutils literal notranslate"><span class="pre">getRevInfo</span></code>.
See this <a class="reference external" href="https://github.com/buildbot/buildbot/pull/2523">discussion</a> with Twisted experts for more information.</p>
</div>
<p>Be careful with local variables. For example, if <code class="docutils literal notranslate"><span class="pre">parse_rev_parse</span></code>, above,
merely assigned <code class="docutils literal notranslate"><span class="pre">rev</span> <span class="pre">=</span> <span class="pre">res.strip()</span></code>, then that variable would be local to
<code class="docutils literal notranslate"><span class="pre">parse_rev_parse</span></code> and not available in <code class="docutils literal notranslate"><span class="pre">set_results</span></code>. Mutable variables
(dicts and lists) at the outer function level are appropriate for this purpose.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">do not try to build a loop in this style by chaining multiple
Deferreds!  Unbounded chaining can result in stack overflows, at least on older
versions of Twisted. Use <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code> instead.</p>
</div>
<p>In most of the cases if you need more than two callbacks in a method, it is more readable and maintainable to use inlineCallbacks.</p>
</div>
<div class="section" id="inlinecallbacks">
<h4>inlineCallbacks<a class="headerlink" href="#inlinecallbacks" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.defer.inlineCallbacks</span></code> is a great help to writing code
that makes a lot of asynchronous calls, particularly if those calls are made in
loop or conditionals.  Refer to the Twisted documentation for the details, but
the style within Buildbot is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">mymethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">xval</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">getSomething</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="k">yield</span> <span class="n">getZValues</span><span class="p">()):</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">z</span>

    <span class="k">if</span> <span class="n">xval</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xval</span> <span class="o">+</span> <span class="n">y</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">someOtherMethod</span><span class="p">()</span>
</pre></div>
</div>
<p>The key points to notice here:</p>
<ul class="simple">
<li>Always import <code class="docutils literal notranslate"><span class="pre">defer</span></code> as a module, not the names within it.</li>
<li>Use the decorator form of <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code>.</li>
<li>In most cases, the result of a <code class="docutils literal notranslate"><span class="pre">yield</span></code> expression should be assigned to a
variable.  It can be used in a larger expression, but remember that Python
requires that you enclose the expression in its own set of parentheses.</li>
<li>Python does not permit returning a value from a generator, so statements like
<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">xval</span> <span class="pre">+</span> <span class="pre">y</span></code> are invalid.  Instead, yield the result of
<code class="docutils literal notranslate"><span class="pre">defer.returnValue</span></code>.  Although this function does cause an immediate
function exit, for clarity follow it with a bare <code class="docutils literal notranslate"><span class="pre">return</span></code>, as in
the example, unless it is the last statement in a function.</li>
</ul>
<p>The great advantage of <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code> is that it allows you to use all
of the usual Pythonic control structures in their natural form. In particular,
it is easy to represent a loop, or even nested loops, in this style without
losing any readability.</p>
<p>Note that code using <code class="docutils literal notranslate"><span class="pre">deferredGenerator</span></code> is no longer acceptable in Buildbot.</p>
<p>The previous <code class="xref py py-func docutils literal notranslate"><span class="pre">getRevInfo</span></code> example implementation should rather be written as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@defer</span><span class="o">.</span><span class="n">inlineCallbacks</span>
<span class="k">def</span> <span class="nf">getRevInfo</span><span class="p">(</span><span class="n">revname</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="n">git</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="n">revname</span> <span class="p">])</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="n">git</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=</span><span class="si">%s</span><span class="s1">%n%b&#39;</span><span class="p">,</span>
                                             <span class="n">results</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="p">])</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
<div class="section" id="locking">
<h4>Locking<a class="headerlink" href="#locking" title="Permalink to this headline">¶</a></h4>
<p>Remember that asynchronous programming does not free you from the need to worry
about concurrency issues.  Particularly if you are executing a sequence of
operations, each time you wait for a Deferred, arbitrary other actions can take
place.</p>
<p>In general, you should try to perform actions atomically, but for the rare
situations that require synchronization, the following might be useful:</p>
<ul class="simple">
<li><code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.defer.DeferredLock</span></code></li>
<li><a class="reference internal" href="utils.html#buildbot.util.misc.deferredLocked" title="buildbot.util.misc.deferredLocked"><code class="xref py py-func docutils literal notranslate"><span class="pre">buildbot.util.misc.deferredLocked</span></code></a></li>
</ul>
</div>
</div>
<div class="section" id="joining-sequences">
<h3>Joining Sequences<a class="headerlink" href="#joining-sequences" title="Permalink to this headline">¶</a></h3>
<p>It’s often the case that you’ll want to perform multiple operations in
parallel, and re-join the results at the end. For this purpose, you’ll want to
use a <a class="reference external" href="http://twistedmatrix.com/documents/current/api/twisted.internet.defer.DeferredList.html">DeferredList</a>
:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getRevInfo</span><span class="p">(</span><span class="n">revname</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rev_parse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">rev_parse_d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="n">git</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="n">revname</span> <span class="p">])</span>
    <span class="k">def</span> <span class="nf">parse_rev_parse</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">rev_parse_d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">parse_rev_parse</span><span class="p">)</span>

    <span class="n">log_d</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="n">git</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=</span><span class="si">%s</span><span class="s1">%n%b&#39;</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="p">])</span>
    <span class="k">def</span> <span class="nf">parse_log</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">log_d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">parse_log</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">DeferredList</span><span class="p">([</span><span class="n">rev_parse_d</span><span class="p">,</span> <span class="n">log_d</span><span class="p">],</span> <span class="n">consumeErrors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fireOnFirstErrback</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_results</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rev</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">handle_results</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>Here the deferred list will wait for both <code class="docutils literal notranslate"><span class="pre">rev_parse_d</span></code> and <code class="docutils literal notranslate"><span class="pre">log_d</span></code> to
fire, or for one of them to fail. You may attach callbacks and errbacks to a
<code class="docutils literal notranslate"><span class="pre">DeferredList</span></code> just as for a deferred.</p>
</div>
<div class="section" id="functions-running-outside-of-the-main-thread">
<h3>Functions running outside of the main thread<a class="headerlink" href="#functions-running-outside-of-the-main-thread" title="Permalink to this headline">¶</a></h3>
<p>It is very important in Twisted to be able to distinguish functions that runs in the main thread and functions that don’t, as reactors and deferreds can only be used in the main thread.
To make this distinction clearer, every functions meant to be started in a secondary thread must be prefixed with <code class="docutils literal notranslate"><span class="pre">thd_</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tests.html" class="btn btn-neutral float-right" title="3.3.3. Buildbot’s Test Suite" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="master-overview.html" class="btn btn-neutral float-left" title="3.3.1. Master Organization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Buildbot Team Members

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>